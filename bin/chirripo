#!/usr/bin/env php

<?php

if (\file_exists(__DIR__ . '/../vendor/autoload.php')) {
    require_once __DIR__ . '/../vendor/autoload.php';
} elseif (\file_exists(__DIR__ . '/../../../autoload.php')) {
    require_once __DIR__ . '/../../../autoload.php';
}

use Symfony\Component\Console\Application;
use Symfony\Component\Dotenv\Dotenv;
use Consolidation\AnnotatedCommand\CommandFileDiscovery;

use Chirripo\Commands\TestCommand;

$dotenv = new Dotenv();
if (\file_exists(__DIR__ . '/../../.env')) {
    $dotenv->load(__DIR__ . '/../../.env');
} elseif (\file_exists(__DIR__ . '/../../../../.env')) {
    $dotenv->load(__DIR__ . '/../../../../.env');
}

$project_root = str_replace('~', $_SERVER['HOME'], $_SERVER['PROJECT_ROOT']);

$chirripo_root = $project_root . '/vendor/chirripo/chirripo';

if (!file_exists($chirripo_root)) {
    $chirripo_root = $project_root;
}

$chirripo_commands_folder = $chirripo_root . '/src/App/Commands';

$discovery = new CommandFileDiscovery();
$discovery->setSearchPattern('*Command.php');
$default_command_classes = $discovery->discover($chirripo_commands_folder, 'Console\App\Commands');

$custom_commands_folder = $project_root . '/src/Chirripo/Commands/';
var_dump($custom_commands_folder);
$custom_commands_classes = [];
if (file_exists($custom_commands_folder)) {
    echo 'FILE EXISTS!';
    $custom_commands_classes = $discovery->discover($custom_commands_folder, 'Chirripo\Commands');
}

$command_classes = array_merge($default_command_classes, $custom_commands_classes);

$app = new Application();
$app->setName('Chirripo CLI Tool');

foreach ($command_classes as $command_class) {
    $app->add(new $command_class());
}

$app->run();